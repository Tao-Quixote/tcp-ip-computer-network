# 路由

在大多数基本形式中，路由器是负责根据逻辑地址对通信流量进行过滤的设备。经典的网络路由器工作于网际层（OSI模型的网络层），使用网际层报头中的IP寻址信息。网络层在OSI中也被简称为第3层，因此路由器有时被称为第3层设备。

当路由器将数据从一个网络传输到下一个网络时，它会替换网络访问层报头信息，因此路由器可以连接不同类型的网络。

IP地址是属于适配器的，而不是属于计算机的。

路由表和网际层其他路由元素的用途在于把数据传递到正确的本地网络。当数据到达本地网络之后，网络访问协议就会知道它的目的地。因此，路由表不需要存储完整的IP地址，只需要列出网络ID即可。知道网络 ID 后即可以通过 MAC 地址发送数据报。

## IP 转发

1．一台主机准备发送一个IP数据报，它查看自己的路由表。

2．如果数据报不能在本地网络上发送，主机就会从路由表里获取与目的地址相关联的路由器的IP地址（对于本地网段上的主机来说，这个路由器的IP地址一般都是默认网关的地址）。路由器的IP地址被ARP协议解析为物理地址。

3．数据报（目的是远程主机）和路由器的物理地址一起被传递给网络访问层。

4．路由器的网络适配器会接收到这个帧，因为帧的目的物理地址与路由器的物理地址相匹配。

5．路由器对帧进行拆包，把数据报传递给网际层。

6．路由器查看数据报的IP地址。如果这个地址匹配路由器自己的IP地址，就表示数据是要发给路由器本身的；否则，路由器会查看自己的路由表，找到与数据报目的地址相关联的路由器，尝试转发这个数据报。

7．如果不能把数据报发送到与路由器相连接的任何网段，路由器就把数据报发送给另一台路由器，上述过程就会重复进行（从第1步开始），直到最后一个路由器能够把数据报直接传输给目的主机。

## 动态路由

一个路由器组内部的路由器会交换足够多的关于网络的信息，使每台路由器建立的路由表都能够描述出把数据报传输给任何网段的路径。路由器的行为完全依赖于路由表。目前使用的路由协议有多种，其中很多是围绕着两种路由方法之一设计的，这两种方法分别是距离矢量路由和链路状态路由。

### 距离矢量路由

距离矢量路由的设计目标是让路由器之间所需的通信最少，让路由表中必须保留的数据最少。路由器不必知道通向每个网段的完整路径，而是只需知道向哪个方向发送数据报即可（这也是术语“矢量”的由来）。网段之间的距离以数据报在两个网络之间传输必须经过的路由器的数量来表示，而使用距离矢量路由的路由器优化路径的方式是让数据报必须经过的路由器达到最少。这个距离参数被称为“跳数”。

1．当路由器 A 初始化时，它感知到直接连接的网段，并把这些网段写入到自己的路由表中。这些直连网段的跳数是0，因为数据报从这台路由器到达这些网段不需要经过其他路由器。

2．在周期性的时间间隔中，路由器接收到来自邻居路由器的报告，其中包含了邻居路由器所感知的网段和相应的跳数。

3．当路由器 A 从邻居路由器收到报告后，按照如下方法把新路由信息添加到自己的路由表中。

*  如果路由器B的信息中包含一个路由器A目前还不知道的网段，路由器A就把这个网段添加到自己的路由表中。去往这个新网段的路由就是路由器 B，也就是说，如果路由器A收到发向这个新网段的数据报，它会转发给路由器B。对于路由器A来说，这个新网段的跳数是路由器B的信息中列出的跳数再加1，因为它与路由器B相比，到达这个网段需要多一跳。
*  如果路由器B的信息中包含的网段已经存在于路由器A的路由表中，路由器A就会把收到的跳数加 1，把得到的值与自己路由表中的值相比较。如果经过路由器 B的路径比路由器A已经掌握的路径更有效率（跳数更小），路由器A就更新自己的路由器表，把路由器B作为通向相应网段的路径。
*  如果通过路由器 B 的跳数比路由器 A 路由表中当前的路径跳数大，经过路由器 B的路径就不会被使用，路由器A继续使用自己路由表中保存的路径。

随着每一轮路由表的更新，路由器对网络的了解越来越全面。关于路由的信息逐渐散布到整个网络。假设网络不发生改变，路由器就会最终了解到通向每个网段的最高效的路径。

### 链路状态路由

在假定路径效率等同于经过的路由器数量时，距离矢量路由是个很好的方法。这种假设的初衷很好，但在有些情况下过于简单了（即使在跳数一样的情况下，经过低速链路的路由也会比经过高速链路的慢）。另外，距离矢量路由并不特别适用于具有大量路由器的环境，因为每台路由器为每个目的网段都必须维护一个路由条目，而这些条目不过是矢量和跳数。路由器无法充分利用对网络结构的更多了解来提升其效率。

连接状态路由背后的理念在于每个路由器都尝试建立关于网络拓扑的内部映射。每台路由器定期向网络发送状态信息，其中列出了自己直连的其他路由器以及链路的状态（链路在当前是否可用）。路由器利用从其他路由器收到的状态消息建立网络拓扑的映射，当它需要转发数据报时，会根据现有条件选择最佳路径。

### 内部路由器

内部路由器工作于自治网络的内部，它会掌握自己组内全部路由器所连接的网段信息，但不需要完整了解自治系统之外的网络。

#### 路由信息协议 RIP

像其他距离矢量协议一样，当网络处于平衡状态时，RIP 工作效果最好。如果路由器的数量变得非常大，路由表的缓慢收敛就可能导致问题。出于这个原因，RIP 设置了从第一台路由器到达目的的最大跳数限制，其值是15。这个规定限制了路由器组的数量，但如果以层级方式组织路由器，15跳范围之内也可以组成大型网络。

## Info

* <web.taox@gmail.com>
* [GitHub](https://github.com/Tao-Quixote)